{% load navigation %} 
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PlaQuery</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css">
  <!-- jQuery UI CSS for autocomplete -->
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <!-- Font Awesome CSS for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- Bootstrap Tags Input CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.css">
  <!-- Google Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400&display=swap">
  <style>
    html {
      font-family: sans-serif;
      padding: 0;
      margin: 0;
    }
    body {
      max-width: 100%;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      position: relative;
      background: linear-gradient(
        to bottom,
        #f8f8f8 0%,
        #f6f6f6 25%,
        #f4f4f4 50%,
        #f2f2f2 75%,
        #f0f0f0 100%
      );
    }
    html, body {
      overflow-x: hidden;
      height: auto;
    }
    h1, h2, h3, h4, h5, h6 {
      font-family: 'Montserrat', Arial, Helvetica, sans-serif;
      color: #377ba8;
      margin: 1rem 0;
    }
    a {
      color: #377ba8;
    }
    hr {
      border: none;
      border-top: 1px solid lightgray;
    }
    .container-fluid {
      padding: 0 35px;
      flex: 1 0 auto;
      padding-bottom: 3rem;
      text-align: left;
    }
    .custom-footer {
      position: relative;
      width: 100%;
      z-index: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #e0e0e0;
      padding: 1.5rem 0;
    }
    .custom-footer p {
      margin: 0;
    }

    /* Toolbar styles */
    .main-toolbar {
      background-color: #fff;
      color: #333;
      flex-wrap: wrap;
      padding: 0 20px;
      height: auto;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      border-bottom: 1px solid #ccc;
    }
    .app-logo {
      display: flex;
      align-items: center;
      text-decoration: none;
      color: #377ba8;
      font-size: 27px;
      font-weight: bold;
      margin-right: 40px;
      transform: translateY(2px);
    }
    .app-logo:hover .app-title {
      color: #4a90d9 !important;
      text-decoration: none;
    }
    .app-title {
      font-size: 27px;
      font-weight: bold;
      font-family: 'Montserrat', sans-serif;
      color: #377ba8 !important;
      padding-bottom: 8px;
    }
    .nav-tabs {
      border-bottom: none !important;
      margin-bottom: 0;
    }

    .nav-tabs > li > a {
      font-family: 'Montserrat', sans-serif !important;
      font-size: 16px !important;
      color: #0d6efd !important;
      padding: 10px 15px;
      background-color: #fff !important;
    }

    .nav-tabs > li > a:focus {
      font-family: 'Montserrat', sans-serif !important;
      color: #0a58ca !important;
      padding: 10px 15px;
      background-color: #fff !important;
    }

    .nav-tabs > li > a:hover {
      font-family: 'Montserrat', sans-serif !important;
      color: #0a58ca !important;
      padding: 10px 15px;
      background-color: #f8f9fa !important;
    }

    .nav-tabs > li.active > a,
    .nav-tabs > li.active > a:hover,
    .nav-tabs > li.active > a:focus {
      color: #0a58ca !important;
      background-color: #f8f9fa !important;
      border-color: #e9ecef #e9ecef #dee2e6 !important;
      cursor: pointer;
    }

    .logout-tab {
      margin-left: auto;
      padding: 10px 15px;
      color: #0d6efd;
      background-color: #fff;
      font-family: 'Montserrat', sans-serif;
      text-decoration: none;
      font-size: 16px;
      border: 1px solid transparent;
      border-radius: 4px 4px 0 0;
      transition: all 0.3s ease;
    }

    .logout-tab:hover {
      color: #0a58ca;
      background-color: #f8f9fa;
      border-color: #dee2e6;
      border-bottom: 1px solid #dee2e6;
    }

    /* Search section styles - updated background to light grey */
    .search-section {
      background: #f0f0f0;
      padding: 40px 0 50px;
      text-align: center;
      color: #333;
    }
    .search-title {
      font-size: 25px;
      font-weight: bold;
      margin-bottom: 20px;
      color: #377ba8;
      font-family: 'Montserrat', sans-serif;
    }
    .examples-text {
      display: inline-flex;
      position: relative;
      flex-wrap: wrap;
      margin-left: 0;
      margin-top: 0.8rem;
      font-family: 'Montserrat', Arial, Helvetica, sans-serif;
      color: #666;
      gap: 0.3rem;
      font-size: 0.875rem;
      font-weight: 600;
    }
    .examples-text::before {
      content: "Examples:";
      margin-right: 0.3rem;
    }
    .examples-text .example-term {
      color:   #666;
      cursor:  pointer;
      transition: color 0.2s ease;
    }
    .examples-text .example-term:hover {
      color:   #4a90d9;
    }
    .search-container {
      display: flex;
      max-width: 900px;
      width: 100%;
      min-height: 40px;
      max-height: 60px;
      margin: 0 auto;
    }
    .search-input-wrapper {
      flex-grow: 1;
      max-width: 100%;
      overflow-y: hidden;
      overflow-x: hidden;
      white-space: nowrap;
      border-radius: 0 !important;
    }
    .search-field-wrapper {
      border-radius: 8px;
      position: relative;
      width: 100%;
      box-shadow:
        inset 100px 0 0 #f8f9fa,
        0 3px 10px rgba(0,0,0,0.4)
        !important;
      background-color: #f8f9fa;
      display: flex;
      padding-left: 100px;
    }
    .search-field-container {
      display: flex;
      width: 100%;
      align-items: center;
      min-height: 40px;
      max-height: 60px;
      border-radius: 0 8px 8px 0;
      background-color: #f8f9fa;
      position: relative;
      overflow: hidden;
    }

    /* Tags input styling */
    .bootstrap-tagsinput {
      width: 100%;
      border: none;
      border-radius: 0;
      box-shadow: none;
      padding: 6px 6px;
      background-color: white;
      max-height: 100%;
      overflow-y: hidden;
      overflow-x: auto;
      display: flex;
      position: relative;
      align-items: center;
      cursor: text;
      white-space: nowrap;
      flex-wrap: nowrap;
      scrollbar-width: thin;
      scroll-behavior: smooth;
    }
    .bootstrap-tagsinput > .twitter-typeahead {
      flex: 1 0 auto;
      min-width: 24ch;
      max-width: 100% !important;
      width: auto !important;
      overflow: hidden;
    }
    .tt-menu,
    .bootstrap-tagsinput .tt-menu{
      display:none !important;
    }
    .bootstrap-tagsinput .tt-hint {
      width: 100% !important;
      white-space: pre !important;
      box-sizing: border-box;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
      color:#9ca3af;
    }
    .bootstrap-tagsinput .tt-input {
      min-width: 24ch !important;
      width: 100% !important;
      position: relative;
      z-index: 2;
      background: transparent;
      box-sizing: border-box;
    }
    .bootstrap-tagsinput .tag {
      background-color: #377ba8;
      color: white;
      border-radius: 4px;
      padding: 2px 6px;
      margin-right: 5px;
      margin-bottom: 0;
      display: inline-block;
      line-height: 1.5;
    }
    .bootstrap-tagsinput .tag [data-role="remove"] {
      margin-left: 6px;
      cursor: pointer;
    }
    .bootstrap-tagsinput .tag [data-role="remove"]:after {
      content: "×";
      padding: 0 2px;
      position: relative;
      top: -1px;
    }
    .bootstrap-tagsinput .tag [data-role="remove"]:hover {
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    .search-options {
      display: flex;
      background-color: transparent;
      padding: 0 15px;
      align-items: center;
      height: 100%;
      gap: 1rem;
      border-radius: 0 8px 8px 0;
      box-sizing: border-box;
    }
    .list-btn {
      background: none;
      border: none;
      color: #555;
      font-weight: 500;
      cursor: pointer;
      padding: 0 10px;
    }
    .list-btn:hover {
      color: #377ba8;
    }
    .search-btn {
      background-color: #377ba8;
      color: white;
      border: none;
      padding: 8px 20px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .search-btn:hover {
      background-color: #4a90d9;
    }
    /* Filters styles */
    .filters-container {
      max-width: 100%;
      margin: 30px auto;
      display: flex;
      justify-content: stretch;
      flex-wrap: wrap;
      gap: 15px;
      padding: 0;
      width: 100%;
    }
    .filter-element {
      position: relative;
      overflow: visible;
      height: 45px;
      border-radius: 6px;
      background-color: white;
      border: 1px solid #377ba8;
      border-radius: 7px;
      cursor: pointer;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      box-sizing: border-box;
    }
    .filter-element:hover {
      border-color: #377ba8;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    .filter-select {
      pointer-events: none;
      width: 100%;
      height: 100%;
      border: none;
      padding: 0 15px;
      background-color: transparent;
      position: relative;
      font-weight: normal;
      z-index: 2;
      cursor: pointer;
      appearance: none;
      background-repeat: no-repeat;
      background-position: calc(100% - 15px) center;
    }
    .filter-select option[disabled],
    .filter-select option[hidden] {
      display: none !important;
    }
    .filter-select:focus {
      outline: none;
    }
    #predictForm .filters-container .filter-element {
      width: 92%;
      max-width: 92%;
      box-sizing: border-box;
    }

    #patientSearchForm .filters-container {
      margin-top: 22px !important;
      margin-bottom: 22px !important;
    }

    /* Patient search form filter styles */
    #patientSearchForm .filters-container {
      justify-content: center;
    }
    #patientSearchForm .filters-container .filter-element {
      width: 225px;
      max-width: 225px;
      box-sizing: border-box;
    }

    /* Multiselect custom styles */
    .multiselect {
      width: 100%;
      position: relative;
      height: 100%;
    }
    .selectBox {
      position: relative;
      cursor: pointer;
      position: relative;
      z-index: 1;
      height: 100%;
      width: 100%;
    }
    .selectBox::after {
      content: "\f078";
      font-family: "Font Awesome 5 Free";
      font-weight: 900;
      font-size: 14px;
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      transition: transform 0.3s ease;
    }
    .selectBox.expanded::after {
      transform: translateY(-50%) rotate(180deg);
    }
    .selectBox select {
      width: 100%;
      font-weight: normal;
      font-size: 16px;
      height: 100%;
    }
    .overSelect {
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
    }
    .checkboxes {
      display: none;
      z-index: 3;
      border: 1px solid #dadada;
      background: white;
      position: absolute;
      left: 0;
      right: auto;
      width: auto !important;
      min-width: 100%;
      max-width: none;
      max-height: 300px;
      overflow-y: auto;
      white-space: nowrap;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      box-sizing: border-box;
    }
    .checkboxes label {
      display: block;
      padding: 5px 10px;
      text-align: left;
    }
    .checkboxes label:hover {
      background-color: #1e90ff;
      color: white;
    }
    .checkboxes label,
    .checkboxes input[type="checkbox"] {
      cursor: pointer;
    }
    /* More options button */
    .more-options-container {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-top: 15px;
    }
    .more-options-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 20px;
      height: 45px;
      background-color: #f1f1f1;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .more-options-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(0, 150, 136, 0.2), transparent);
      transition: all 0.5s ease;
    }
    .more-options-btn:hover::before {
      left: 100%;
    }
    .more-options-btn:hover {
      border-color: #377ba8;
      background-color: #e9e9e9;
    }
    .more-options-btn i {
      margin-left: 8px;
      transition: transform 0.3s ease;
    }
    .more-options-btn.expanded i {
      transform: rotate(180deg);
    }
    .animated-button {
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    .animated-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(0, 150, 136, 0.2), transparent);
      transition: all 0.5s ease;
    }
    .animated-button:hover::before {
      left: 100%;
    }
    .animated-button:hover {
      border-color: #377ba8;
    }
    /* Additional filters container */
    .additional-filters {
      display: none;
      width: 100%;
      max-width: 1200px;
      margin: 15px auto 0;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
    }
    .additional-filters.show {
      display: flex;
    }
    .apply-filters-container {
      text-align: center;
      margin: 20px auto;
    }
    .apply-filters-btn {
      position: relative;
      overflow: hidden;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0 15px;
      height: 40px;
      background-color: #f1f1f1;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    .apply-filters-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(0, 150, 136, 0.2), transparent);
      transition: all 0.5s ease;
    }
    .apply-filters-btn:hover::before {
      left: 100%;
    }
    .apply-filters-btn:hover {
      background-color: #e9e9e9;
      border-color: #377ba8;
    }
    button {
      transition: transform 0.2s ease;
    }
    button:active {
      transform: scale(0.95);
    }
    .more-options-btn,
    .apply-filters-btn,
    .action-btn,
    .input-group-text {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }
    #table-search {
      position: relative;
      z-index: 1;
      box-shadow: 4px 4px 6px rgba(0, 0, 0, 0.2);
    }
    /* Results table styles */
    .results-container {
      max-width: 1400px;
      margin: 45px auto 30px;
      padding: 0 35px;
    }
    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .results-title {
      font-size: 20px;
      font-weight: 600;
      color: #333;
      font-family: 'Montserrat', sans-serif;
    }
    .results-actions {
      display: flex;
      gap: 10px;
    }
    .results-actions .input-group-text {
      position: relative;
      box-shadow: 4px 4px 6px rgba(0,0,0,0.2);
    }
    .action-btn {
      padding: 6px 12px;
      background-color: #f1f1f1;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .action-btn:hover {
      background-color: #e9e9e9;
      border-color:  #377ba8;
    }
    .more-options-btn:hover,
    .apply-filters-btn:hover,
    .action-btn:hover {
      transform: translateY(-1px);
      transition: all 0.15s ease;
    }
    #table-search:focus {
      border-color: #377ba8;
      box-shadow: 0 0 0 0.2rem rgba(55,123,168,0.25);
    }
    .input-group-text .fa-search {
      color: #5a6268;
    }
    .input-group {
      overflow: visible;
    }
    .results-table-container {
      max-height: 550px;
      overflow: auto;
      position: relative;
    }
    .results-table {
      width: 100%;
      table-layout: auto;
      border-collapse: collapse;
      background-color: #f5f5f5;
    }
    .results-table th {
      background-color: #f8f9fa;
      padding: 15px 15px !important;
      font-weight: 600;
      color: #333;
      width: fit-content;
      min-width: 100px;
      max-width: 500px;
      white-space: nowrap !important;
      text-align: center;
      vertical-align: middle;
    }
    .results-table tbody tr:nth-child(even) {
      background-color: #ffffff;
    }
    .results-table tbody tr:nth-child(odd) {
      background-color: #f5f5f5;
    }
    .results-table td {
      padding: 8px 29px !important;
      border-bottom: 1px solid #eee;
      text-align: center !important;
      vertical-align: middle;
      white-space: nowrap !important;
    }
    .cell-content {
      min-width: 100px;
      max-width: 500px;
      width: fit-content;
      white-space: nowrap;
      text-align: center;
      display: inline-block;
    }
    .results-table tr:hover {
      background-color: #e9e9e9 !important;
    }
    .results-table thead th {
      position: sticky;
      top: 0;
      background-color: #f8f9fa;
      z-index: 2;
    }
    .results-table thead th::before {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      height: 2.5px;
      background-color: #ddd;
      pointer-events: none;
    }
    .results-table thead th::after {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      height: 2.5px;
      background-color: #ddd;
      pointer-events: none;
    }
    /* New Results Footer */
    .results-footer {
      background-color: #f8f9fa;
      padding: 6px 0;
      text-align: center;
      border-bottom: 2.5px solid #ddd;
    }
    .results-footer .pagination {
      display: inline-flex;
      margin: 0;
    }
    .results-footer.no-pagination {
      padding: 20px 0;
    }
    .pagination .page-item .page-link {
      color: #377ba8;
    }
    .pagination .page-item.active .page-link {
      background-color: #377ba8;
      border-color: #377ba8;
      color: white;
    }
    .progress-container {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 400px;
      height: 20px;
      z-index: 100;
      background-color: transparent;
      border: 2px solid #bbb;
      border-radius: 12px;
      overflow: hidden;
    }
    @keyframes stripeAnimation {
      from {
        background-position: 0 0;
      }
      to {
        background-position: -20px 0;
      }
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: repeating-linear-gradient(
        55deg,
        #377ba8 0,
        #377ba8 10px,
        #2f6394 10px,
        #2f6394 20px
      );
      background-size: 20px 20px;
      animation: stripeAnimation 0.5s linear infinite;
      transition: width 0.4s ease;
    }
    .blur {
      filter: blur(6px);
      transition: filter 0.4s ease;
      pointer-events:none;
    }
    .no-scroll {
      overflow: hidden;
    }
    .pagination.disabled {
      pointer-events: none;
      opacity: 0.5;
    }
    .empty-state {
      text-align: center;
      padding: 40px 0;
      color: #777;
      min-height: 515px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: #f8f9fa;
      border-top: 2px solid #ddd;
    }
    .empty-state i {
      font-size: 60px;
      margin-bottom: 15px;
      color: #bbb;
    }
    button {
      transition: transform 0.2s ease;
    }
    button:active {
      transform: scale(0.95);
    }

    .tooltip.calc-tooltip {
      opacity: 1 !important;
      pointer-events: none !important;
    }
    
    .tooltip.calc-tooltip .tooltip-inner {
      background-color: #f6dc9a !important;
      color:            #272727 !important;
      z-index:          10002 !important;
      font-size: 14px !important;
      border-radius: 6px !important;
      font-family: 'Inter', sans-serif !important;
      font-weight: 300 !important;
      display:inline-block;
      max-width:265px;
      width:fit-content;
      padding:8px 12px !important;
      pointer-events: none !important;
    }

    .tooltip.calc-hyphen .tooltip-inner{
      hyphens:auto !important;
      text-align: justify !important;
      text-justify: inter-word !important;
    }

    @supports not (width:fit-content){
      .tooltip.calc-tooltip .tooltip-inner{
        width:auto;
        max-width:265px;
      }
    }

    .tooltip.calc-tooltip .tooltip-arrow::before {
      content: "" !important;
      position: absolute !important;
      border-style: solid !important;
    }

    .tooltip.calc-tooltip.bs-tooltip-top .tooltip-arrow::before {
      border-width: 0.6rem 0.6rem 0    0.6rem !important;
      border-color: #f6dc9a transparent transparent transparent !important;
      margin-top: 2.5px !important;
    }

    .tooltip.calc-tooltip.bs-tooltip-right .tooltip-arrow::before {
      border-width: 0.6rem 0.6rem 0.6rem 0    !important;
      border-color: transparent #f6dc9a transparent transparent !important;
      margin-right: 2.5px !important;
    }

    .tooltip.calc-tooltip.bs-tooltip-bottom .tooltip-arrow::before {
      border-width: 0    0.6rem 0.6rem 0.6rem !important;
      border-color: transparent transparent #f6dc9a transparent !important;
      margin-bottom: 2.5px !important;
    }

    .tooltip.calc-tooltip.bs-tooltip-left .tooltip-arrow::before {
      border-width: 0.6rem 0    0.6rem 0.6rem !important;
      border-color: transparent transparent transparent #f6dc9a !important;
      margin-left: 2.5px !important;
    }

    /* ▸ Keep default colours for switches / checkboxes, even when they are :valid */
    .was-validated .form-switch .form-check-input:valid,
    .form-switch      .form-check-input.is-valid           {         /* switch OFF  */
      border-color:#adb5bd;      /* Bootstrap's neutral border        */
      background-color:#fff;     /* neutral background                */
    }

    /* ▸ When the switch is ON keep the usual blue track / thumb       */
    .was-validated .form-switch .form-check-input:valid:checked,
    .form-switch      .form-check-input.is-valid:checked   {         /* switch ON   */
      background-color:#0d6efd;  /* same colour as .form-check-input:checked */
      border-color:#0d6efd;
    }

    /* ▸ Leave the label text in its normal colour                      */
    .was-validated .form-switch .form-check-input:valid + .form-check-label,
    .form-switch      .form-check-label.is-valid           {
      color:inherit;
    }

    #predictForm .form-check-input {
      cursor: pointer;
    }

    /* Form left alignment and narrower width */
    #predictForm {
      text-align: center;
      max-width: 600px;
      min-width: 350px;
      width: 100%;
      border-radius: 0.5rem;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.3);
    }

    #predictForm .form-text {   
      width: 91%; 
      margin: 4px auto; 
      text-align: left; 
    }

    #predictForm h4 {
      text-align: center;
    }

    #predictForm #sample_file.form-control {
      width: 92%;
      max-width: 92%;
    }

    #predictForm input[type="file"],
    #predictForm select.form-control {
      display: block;
      margin: 0 auto;    
    }

    #predictForm .form-check-input {
      transform: scale(1.2);
      margin-right: 0.5rem;
      transform-origin: left center;
    }

    #predictForm .form-check.form-switch {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0 !important;
      justify-content: center
    }

    #predictForm #protein-note {
      text-align: left;
    } 

    #predictForm .form-check.form-switch .form-check-label {
      position: relative;
      top: 1px;
    }

    #predictForm .filters-container {
      margin-bottom: 15px !important;
      margin-top: 24px !important;
      justify-content: center;
      display: flex;
    }

    #errorBox {
      display: inline-block;
      width: auto;
      margin: 30px 0 8px 58px!important;
    }

    #errorBox:not(.d-none) + .results-container {
      margin-top: 16px !important;
    }

    /* New Patient Search Form styles */
    #patientSearchForm {
      text-align: center;
      border-radius: 0.5rem;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.3);
      margin: 0;
      width: 100%;
    }

    #patientSearchForm h4 {
      text-align: center;
    }

    #patientSearchForm h4.mb-4 {
      margin-bottom: 22px !important;
    }

    #patientSearchForm .filters-container:first-of-type .filter-element {
      width: 320px !important;
      max-width: none !important;
      flex: none;
    }

    /* Custom layout for forms */
    .forms-container {
      display: flex;
      gap: 35px;
      align-items: flex-start;
    }

    .predict-form-wrapper {
      flex: 0 0 auto;
      width: 600px;
      max-width: 600px;
    }

    .search-form-wrapper {
      flex: 1;
    }

    /* Search submit button styles */
    .search-submit-btn {
      background-color: #377ba8;
      color: white;
      border: none;
      padding: 10px 30px;
      font-weight: 500;
      cursor: pointer !important;
      border-radius: 6px;
      transition: background-color 0.3s ease;
      margin-top: 20px;
    }

    #predictForm .search-submit-btn,
    #patientSearchForm .search-submit-btn {
      width: 250px;              
      max-width: 250px;       
    }

    .search-submit-btn:hover {
      background-color: #4a90d9;
    }

    /* blur everything when loading */
    .blur {
      filter: blur(6px);
      transition: filter 0.4s ease;
      pointer-events: none;
    }

    /* disable scrolling of the table container */
    .no-scroll {
      overflow: hidden;
    }

    /* disable pagination clicks */
    .pagination.disabled {
      pointer-events: none;
      opacity: 0.5;
    }

    /* Media queries for responsive behavior */
    @media (max-width: 576px) {
      #predictForm {
        min-width: 300px;
      }

      .forms-container {
        flex-direction: column;
        gap: 20px;
      }

      .predict-form-wrapper {
        width: 100%;
        max-width: 100%;
      }

      .search-form-wrapper {
        margin-left: 0;
        margin-right: 0;
      }
    }
  </style>
</head>
<body>
  <!-- Top Toolbar from plot.html -->
  <div class="main-toolbar" style="border-bottom: none;">
    <a class="app-logo">
      <span class="app-title">PlaqueMS</span>
    </a>
    <ul class="nav nav-tabs">
      <li class="nav-item">
        <a class="nav-link" href="{% url 'home' %}">Home</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="{% url 'proteins' %}">Proteins</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="{% url 'plot' %}">Differential Expression Analysis</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="{% url 'cy' %}">Protein Networks</a>
      </li>
      {% if user.is_authenticated %}
        <li class="nav-item active keep-active">
          <a class="nav-link" href="{% url 'protein-abundance' %}">PlaQuery</a>
        </li>
      {% endif %}
      {% if user.is_authenticated and user.is_staff %}
        <li class="nav-item">
          <a class="nav-link" href="{% url 'admin_dashboard' %}">Admin Dashboard</a>
        </li>
      {% endif %}
    </ul>
    <!--Right side of the toolbar-->
    <ul class="nav nav-tabs navbar-right" style="margin-left: auto;">
      {% if user.is_authenticated %}
        <li class="nav-item">
          <a class="nav-link" href="{% url 'logout' %}">Log Out</a>
        </li>
      {% else %}
        <li class="nav-item">
          <a class="nav-link" href="{% url 'login' %}">Log In</a>
        </li>
      {% endif %}
    </ul>
  </div>

  <!-- Bottom Toolbar -->
  <div class="main-toolbar">
    <ul class="nav nav-tabs bottom-placeholder-tabs" style="display: flex; justify-content: center; width: 100%;">
      <li class="nav-item">
        <a class="nav-link" href="{% url 'protein-abundance' %}">Protein Abundance</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#">Graph Protein Networks</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="{% url 'calc_predict' %}">Calcification Prediction</a>
      </li>
      <li class="nav-item {% active 'syntax_predict' %}">
        <a class="nav-link" href="{% url 'syntax_predict' %}">Syntax Score Prediction</a>
      </li>
    </ul>
  </div>

  <!-- Calcification Prediction Upload card -->
  <div class="container-fluid mt-4">
    <div class="forms-container">
      <!-- Left - Prediction Form -->
      <div class="predict-form-wrapper">
        <form id="predictForm"
              action="{% url 'syntax_upload' %}"
              method="post" enctype="multipart/form-data"
              class="card p-5 needs-validation"
              novalidate>
          {% csrf_token %}

          <h4 class="mb-4 text-primary fs-3 fw-bold">
            Syntax Score Prediction
          </h4>

          <div class="mb-3">
            <label class="form-label fw-semibold small" for="sample_file">
              Upload your protein abundance table (accepted formats: .csv, .tsv, .xls, .xlsx)
            </label>
            <div class="d-flex gap-2" style="width: 92%; margin: 0 auto;">
              <input
                class="form-control"
                type="file"
                name="sample_file" 
                id="sample_file"
                accept=".csv,.tsv,.txt,.xlsx,.xls" 
                required
              />
              <button
                type="button"
                id="clearSample"
                class="btn btn-outline-danger"
              >
                Clear
              </button>
            </div>
            <div class="form-text">
              Upload either two-column (<code>Protein, Abundance</code>) for one subject <br> or a matrix
              (<code>Proteins × Subjects</code>) for many.
            </div>
          </div>

          <!-- Constant Note -->
          <div id="protein-note" class="alert alert-info my-2">
            <strong>Required proteins:</strong>
            HRG, CP, C4B, F13A1, VCAN
          </div>

          <div class="form-check form-switch mb-4">
            <input class="form-check-input" type="checkbox"
                  id="log2" name="log2" value="1">
            <label class="form-check-label small" for="log2">
              Apply log₂ transformation to data if not already log₂ transformed.
            </label>
          </div>

          <div style="text-align: center; margin-top: 14px;">
            <button type="submit" class="search-submit-btn" id="submitBtn">
              Predict
            </button>
          </div>
        </form>
      </div>

      <!-- Right - Patient Search Form -->
      <div class="search-form-wrapper">
        <form id="patientSearchForm"
              action="{% url 'syntax_filter' %}"
              method="post"
              class="card p-5 needs-validation"
              novalidate>

          <h4 class="mb-4 text-primary fs-3 fw-bold">
            Patient Search in the Database
          </h4>

          <!-- Filter elements from plaquery.html -->
          <div class="filters-container">
            <!-- Plaque Histology Filter -->
            <div class="filter-element">
              <div class="multiselect">
                <div class="selectBox animated-button" onclick="toggleCheckboxes('search-histology-checkboxes')">
                  <select class="filter-select" aria-label="Filter Plaque Histology">
                    <option selected>Filter Plaque Histology</option>
                  </select>
                  <div class="overSelect"></div>
                </div>
                <div id="search-histology-checkboxes" class="checkboxes">
                  {% for h in histologies %}
                    <label onclick="event.stopPropagation();">
                      <input type="checkbox" value="{{ h }}">
                      {{ h }}
                    </label>
                  {% endfor %}
                </div>
              </div>
            </div>

            <!-- Plaque Ultrasound Filter -->
            <div class="filter-element">
              <div class="multiselect">
                <div class="selectBox animated-button" onclick="toggleCheckboxes('search-ultrasound-checkboxes')">
                  <select class="filter-select" aria-label="Filter Plaque Ultrasound">
                    <option selected>Filter Plaque Ultrasound</option>
                  </select>
                  <div class="overSelect"></div>
                </div>
                <div id="search-ultrasound-checkboxes" class="checkboxes">
                  {% for u in ultrasounds %}
                    <label onclick="event.stopPropagation();">
                      <input type="checkbox" value="{{ u }}">
                      {{ u }}
                    </label>
                  {% endfor %}
                </div>
              </div>
            </div>

            <!-- Sex Filter -->
            <div class="filter-element">
              <div class="multiselect">
                <div class="selectBox animated-button" onclick="toggleCheckboxes('search-sex-checkboxes')">
                  <select class="filter-select" aria-label="Filter by Sex">
                    <option selected>Filter by Sex</option>
                  </select>
                  <div class="overSelect"></div>
                </div>
                <div id="search-sex-checkboxes" class="checkboxes">
                  {% for s in sexes %}
                    <label onclick="event.stopPropagation();">
                      <input type="checkbox" value="{{ s }}">
                      {{ s }}
                    </label>
                  {% endfor %}
                </div>
              </div>
            </div>

            <!-- Age Filter -->
            <div class="filter-element">
              <div class="multiselect">
                <div class="selectBox animated-button" onclick="toggleCheckboxes('search-age-checkboxes')">
                  <select class="filter-select" aria-label="Filter by Age">
                    <option selected>Filter by Age</option>
                  </select>
                  <div class="overSelect"></div>
                </div>
                <div id="search-age-checkboxes" class="checkboxes">
                  {% for age_group in age_groups %}
                    <label onclick="event.stopPropagation();">
                      <input type="checkbox" value="{{ age_group }}">
                     {% if age_group == "under40" %}Under 40{% elif age_group == "40to60" %}40-60{% elif age_group == "over60" %}Over 60{% endif %}
                    </label>
                  {% endfor %}
                </div>
              </div>
            </div>

            <!-- Symptoms Filter -->
            <div class="filter-element">
              <div class="multiselect">
                <div class="selectBox animated-button" onclick="toggleCheckboxes('search-symptoms-checkboxes')">
                  <select class="filter-select" aria-label="Filter by Symptoms">
                    <option selected>Filter by Symptoms</option>
                  </select>
                  <div class="overSelect"></div>
                </div>
                <div id="search-symptoms-checkboxes" class="checkboxes">
                  {% for sym in symptoms %}
                    <label onclick="event.stopPropagation();">
                      <input type="checkbox" value="{{ sym }}">
                     {{ sym }}
                   </label>
                  {% endfor %}
                </div>
              </div>
            </div>

            <!-- Clinical Condition Filter (copied from plaquery.html) -->
            <div class="filter-element">
             <div class="multiselect">
                <div class="selectBox animated-button" onclick="toggleCheckboxes('search-clinical-checkboxes')">
                  <select class="filter-select" aria-label="Select Clinical condition">
                    <option selected>Select Clinical condition</option>
                  </select>
                  <div class="overSelect"></div>
                </div>
               <div id="search-clinical-checkboxes" class="checkboxes">
                  <label for="search_clin_1">
                    <input type="checkbox" id="search_clin_1" value="Acute infection"> Acute infection
                  </label>
                  <label for="search_clin_2">
                    <input type="checkbox" id="search_clin_2" value="Acute myocardial infarction"> Acute myocardial infarction
                  </label>
                  <label for="search_clin_3">
                    <input type="checkbox" id="search_clin_3" value="Adipositas(BMI>30)"> Adipositas(BMI>30)
                  </label>
                  <label for="search_clin_4">
                    <input type="checkbox" id="search_clin_4" value="Auto-immune disease"> Auto-immune disease
                  </label>
                  <label for="search_clin_5">
                    <input type="checkbox" id="search_clin_5" value="Cancer"> Cancer
                  </label>
                  <label for="search_clin_6">
                    <input type="checkbox" id="search_clin_6" value="Chronic infection"> Chronic infection
                  </label>
                  <label for="search_clin_7">
                    <input type="checkbox" id="search_clin_7" value="Chronic obstructive pulmonary disease"> Chronic obstructive pulmonary disease
                  </label>
                  <label for="search_clin_8">
                    <input type="checkbox" id="search_clin_8" value="Coronary artery disease"> Coronary artery disease
                  </label>
                  <label for="search_clin_9">
                    <input type="checkbox" id="search_clin_9" value="Diabetes mellitus type 2"> Diabetes mellitus type 2
                  </label>
                  <label for="search_clin_10">
                    <input type="checkbox" id="search_clin_10" value="High Stenosis(≥90%)"> High stenosis(≥90%)
                  </label>
                  <label for="search_clin_11">
                    <input type="checkbox" id="search_clin_11" value="Hyperlipidemia"> Hyperlipidemia
                  </label>
                  <label for="search_clin_12">
                    <input type="checkbox" id="search_clin_12" value="Hypertension"> Hypertension
                  </label>
                  <label for="search_clin_13">
                    <input type="checkbox" id="search_clin_13" value="Peripheral artery disease"> Peripheral artery disease
                  </label>
                  <label for="search_clin_14">
                    <input type="checkbox" id="search_clin_14" value="Stroke history"> Stroke history
                  </label>
                </div>
              </div>
            </div>

            <!-- Clinical Outcomes Filter (copied from plaquery.html) -->
            <div class="filter-element">
              <div class="multiselect">
                <div class="selectBox animated-button" onclick="toggleCheckboxes('search-clinical-outcomes-checkboxes')">
                  <select class="filter-select" aria-label="Filter by Clinical outcomes">
                    <option selected>Select Clinical outcome</option>
                  </select>
                  <div class="overSelect"></div>
                </div>
                <div id="search-clinical-outcomes-checkboxes" class="checkboxes">
                  <label>
                    <input type="checkbox" value="Stroke">
                    Stroke
                  </label>
                  <label>
                    <input type="checkbox" value="Transient ischemic attack">
                    Transient ischemic attack
                  </label>
                  <label>
                    <input type="checkbox" value="Cardiovascular mortality">
                    Cardiovascular mortality
                  </label>
                  <label>
                    <input type="checkbox" value="Primary endpoint">
                    Primary endpoint
                  </label>
                </div>
              </div>
            </div>

            <!-- Calcification by description Filter -->
            <div class="filter-element">
              <div class="multiselect">
                <div class="selectBox animated-button" onclick="toggleCheckboxes('search-calcification-checkboxes')">
                  <select class="filter-select" aria-label="Calcification by description">
                    <option selected>Calcification (clinical)</option>
                  </select>
                  <div class="overSelect"></div>
                </div>
                <div id="search-calcification-checkboxes" class="checkboxes">
                  {% for calc in calcifications %}
                    <label onclick="event.stopPropagation();">
                      <input type="checkbox" value="{{ calc }}">
                      {{ calc }}
                    </label>
                  {% endfor %}
                </div>
              </div>
            </div>

            <!-- Medication Filter (copied from plaquery.html) -->
            <div class="filter-element">
              <div class="multiselect">
                <div class="selectBox animated-button" onclick="toggleCheckboxes('search-medication-checkboxes')">
                  <select class="filter-select" aria-label="Select Medication">
                    <option selected>Select Medication</option>
                  </select>
                  <div class="overSelect"></div>
                </div>
                <div id="search-medication-checkboxes" class="checkboxes">
                  <label for="search_med_1">
                    <input type="checkbox" id="search_med_1" value="ACE inhibitors"> ACE inhibitors
                  </label>
                  <label for="search_med_2">
                    <input type="checkbox" id="search_med_2" value="ARB therapy"> ARB therapy
                  </label>
                  <label for="search_med_3">
                    <input type="checkbox" id="search_med_3" value="Antiplatelet"> Antiplatelet
                  </label>
                  <label for="search_med_4">
                    <input type="checkbox" id="search_med_4" value="Aspirin"> Aspirin
                  </label>
                  <label for="search_med_5">
                    <input type="checkbox" id="search_med_5" value="Beta blockers"> Beta blockers
                  </label>
                  <label for="search_med_6">
                    <input type="checkbox" id="search_med_6" value="Statins"> Statins
                  </label>
                  <label for="search_med_7">
                    <input type="checkbox" id="search_med_7" value="Clopidogrel"> Clopidogrel
                  </label>
                  <label for="search_med_8">
                    <input type="checkbox" id="search_med_8" value="Diuretics"> Diuretics
                  </label>
                </div>
              </div>
            </div>

            <!-- Lifestyle Filter (copied from plaquery.html) -->
            <div class="filter-element">
              <div class="multiselect">
                <div class="selectBox animated-button" onclick="toggleCheckboxes('search-lifestyle-checkboxes')">
                  <select class="filter-select" aria-label="Filter by Lifestyle">
                    <option selected>Filter by Lifestyle</option>
                  </select>
                  <div class="overSelect"></div>
                </div>
                <div id="search-lifestyle-checkboxes" class="checkboxes">
                  <!-- Smoker Status -->
                  <label style="font-weight:bold;">Smoker Status</label>
                  {% for status in smoker_status %}
                    <label onclick="event.stopPropagation();">
                      <input type="checkbox" value="{{ status }}" name="smoker_status">
                      {{ status }}
                    </label>
                  {% endfor %}
                  <!-- Pack-years Ranges -->
                  <label style="font-weight:bold; margin-top:10px;">Pack-years</label>
                  {% for py in pack_years_ranges %}
                    <label onclick="event.stopPropagation();">
                      <input type="checkbox" value="{{ py.value }}" name="pack_years_range">
                      {{ py.label }}
                    </label>
                  {% endfor %}
                  <!-- BMI Ranges -->
                  <label style="font-weight:bold; margin-top:10px;">BMI</label>
                  {% for bmi in bmi_ranges %}
                    <label onclick="event.stopPropagation();">
                      <input type="checkbox" value="{{ bmi.value }}" name="bmi_range">
                      {{ bmi.label }}
                    </label>
                  {% endfor %}
                </div>
              </div>
            </div>

            <!-- Cardiovascular Biomarkers Filter (copied from plaquery.html) -->
            <div class="filter-element">
              <div class="multiselect">
                <div class="selectBox animated-button" onclick="toggleCheckboxes('search-cvbiomarkers-checkboxes')">
                  <select class="filter-select" aria-label="Select cardiovascular biomarkers">
                    <option selected>Select CV biomarkers</option>
                  </select>
                  <div class="overSelect"></div>
                </div>
                <div id="search-cvbiomarkers-checkboxes" class="checkboxes">
                  <label onclick="event.stopPropagation();">
                    <input type="checkbox" value="Cholesterol(total)" name="cvbiomarker">
                    Cholesterol(total)
                  </label>
                  <label onclick="event.stopPropagation();">
                    <input type="checkbox" value="HDL" name="cvbiomarker">
                    HDL
                  </label>
                  <label onclick="event.stopPropagation();">
                    <input type="checkbox" value="LDL" name="cvbiomarker">
                    LDL
                  </label>
                  <label onclick="event.stopPropagation();">
                    <input type="checkbox" value="Triglycerides" name="cvbiomarker">
                    Triglycerides
                  </label>
                  <label onclick="event.stopPropagation();">
                    <input type="checkbox" value="High-sensitivity CRP" name="cvbiomarker">
                    High-sensitivity CRP
                  </label>
                  <label onclick="event.stopPropagation();">
                    <input type="checkbox" value="Ultrasensitive CRP" name="cvbiomarker">
                    Ultrasensitive CRP
                  </label>
                  <label onclick="event.stopPropagation();">
                    <input type="checkbox" value="Pre-surgery BP(diastolic)" name="cvbiomarker">
                    Pre-surgery BP(diastolic)
                  </label>
                  <label onclick="event.stopPropagation();">
                    <input type="checkbox" value="Pre-surgery BP(systolic)" name="cvbiomarker">
                    Pre-surgery BP(systolic)
                  </label>
                  <label onclick="event.stopPropagation();">
                    <input type="checkbox" value="Contralateral stenosis(≥60%)" name="cvbiomarker">
                    Contralateral stenosis(≥60%)
                  </label>
                  <label onclick="event.stopPropagation();">
                    <input type="checkbox" value="Stenosis grade(%)" name="cvbiomarker">
                    Stenosis grade(%)
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Search submit button -->
          <div style="text-align: center;">
            <button type="submit" id="searchBtn" class="search-submit-btn">
              Search
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Error box -->
    <div id="errorBox" class="alert alert-danger mt-4 d-none" style="margin: 0 35px;"></div>

    <!-- Shared Results Area -->
    <div class="results-container">
      <div class="results-header">
        <div class="results-title">Results</div>
        <div class="results-actions">
          <button class="action-btn" onclick="copyResults()">Copy</button>
          <button class="action-btn" onclick="exportToExcel()">Excel</button>
          <button class="action-btn" onclick="exportToCSV()">CSV</button>
          <button class="action-btn" onclick="exportToTSV()">TSV</button>
          <div class="input-group" style="width: 200px;">
            <span class="input-group-text">
              <i class="fas fa-search" aria-hidden="true"></i>
            </span>
            <input type="text" class="form-control" id="table-search" onkeyup="searchTable()">
          </div>
        </div>
      </div>
      <div class="results-wrapper" style="position: relative;">
        <div class="progress-container" id="progress-container" style="display:none;">
          <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div id="results-table-container" class="results-table-container">
          <table id="results-table" class="results-table">
            <thead>
              <tr>
                <th>Subject ID</th>
                <th>Predicted syntax score</th>
              </tr>
            </thead>
            <tbody id="results-body">
              <!-- Results will be populated here -->
            </tbody>
          </table>
          <div id="empty-state" class="empty-state">
            <i class="fas fa-search fa-4x"></i>
            <p>Use the forms above to see prediction results</p>
          </div>
        </div>
      </div>
      <nav aria-label="Results pagination" class="results-footer">
        <ul class="pagination" id="pagination">
          <!-- Pagination will be generated dynamically -->
        </ul>
      </nav>
    </div>
  </div>

  <!-- Footer -->
  <footer class="custom-footer">
    <p>&copy; 2025 PlaqueMS. All rights reserved.</p>
  </footer>

  <!-- JavaScript Libraries -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>

  // Move .active to the tab just clicked; remove any other active tab. (top toolbar)
  $(function () {
    $('.main-toolbar .nav-tabs:not(.bottom-placeholder-tabs)')
      .on('pointerdown', '.nav-link', function (e) {
        const href = this.getAttribute('href'),
              $li  = $(this).parent('.nav-item'),
              $nav = $li.closest('.nav-tabs');

        if (href === '#') {
          e.preventDefault();
        } else {
          e.preventDefault();
          setTimeout(() => { window.location.href = href; }, 150);
        }

        $nav.find('.nav-item.active').removeClass('active');
        $li.addClass('active');
        if (!$li.hasClass('keep-active')) {
          $('.bottom-placeholder-tabs .nav-item.active').removeClass('active');
        }
      });
  });

  // Move .active to the tab just clicked; skip tabs with .keep-active (bottom toolbar)
  $(function () {
    $('.bottom-placeholder-tabs').on('click', '.nav-link', function (e) {
      const href = $(this).attr('href'),
            $li  = $(this).parent('.nav-item'),
            $nav = $li.closest('.nav-tabs');

      if (href === '#') {
        e.preventDefault();
      } else {
        e.preventDefault();
        setTimeout(() => { window.location.href = href; }, 150);
      }

      $nav.find('.nav-item.active').not('.keep-active').removeClass('active');
      $li.addClass('active');
    });
  });

  // Clear button functionality
  document.getElementById('clearSample').addEventListener('click', function() {
    const fileInput = document.getElementById('sample_file');
    fileInput.value = '';
  });

  //Tooltip
  document.addEventListener('DOMContentLoaded', function () {
    new bootstrap.Tooltip(document.body, {
      selector: '[data-bs-toggle="tooltip"]',
      trigger: 'hover',
      container: 'body',
      offset: [0, -10],
      placement: function(tip, trigger) {
        if (!tip.parentNode) {
          tip.style.position = 'absolute';
          tip.style.left     = '-9999px';
          tip.style.top      = '-9999px';
          document.body.appendChild(tip);
        }
        const bubbleHeight = tip.offsetHeight;
        const spaceAbove   = trigger.getBoundingClientRect().top;
      // prefer TOP, but flip to BOTTOM when the clearance above is < 1.5 × bubble height.                                   */
        return (spaceAbove >= 1.2 * bubbleHeight) ? 'top' : 'bottom';
      },
      fallbackPlacements: ['top', 'bottom']
    });
  });

  // master copy for search reset, and current view
  let fullRecords = [];
  let allRecords  = [];
  let currentResultsSource = null; // 'predict' or 'search'

  window.toggleCheckboxes = function (id) {
    const box   = document.getElementById(id);
    const shell = box.parentNode.querySelector('.selectBox');
    const open  = box.style.display === 'block';
    // close any others
    document.querySelectorAll('.multiselect').forEach(ms => {
      ms.querySelector('.checkboxes')?.style.setProperty('display', 'none');
      ms.querySelector('.selectBox')?.classList.remove('expanded');
    });
    box.style.display = open ? 'none' : 'block';
    shell.classList.toggle('expanded', !open);
  };

  document.addEventListener("click", e => {
    if (!e.target.closest('.multiselect')) {
      document.querySelectorAll('.checkboxes').forEach(cb => {
        cb.style.display = 'none';
        cb.parentNode.querySelector('.selectBox').classList.remove('expanded');
      });
    }
  });

  // prediction form validation
  (function () {
    'use strict';
    const form       = document.getElementById('predictForm'),
          fileInput  = document.getElementById('sample_file');
    form.addEventListener('submit', function (ev) {
        if (!fileInput.value) {
            form.classList.add('was-validated');
            fileInput.reportValidity();
            ev.preventDefault();
        }
      }, false);
  })();

  // loading animation (from plaquery)
  function startSmoothProgress() {
    const progressBar = document.getElementById("progress-bar");
    let current = 0;
    return setInterval(() => {
      if (current < 90) {
        progressBar.style.width = (++current) + "%";
      }
    }, 25);
  }
  function showLoadingAnimation() {
    const table = document.getElementById("results-table"),
          wrap  = document.querySelector('.results-table-container'),
          pag   = document.getElementById('pagination'),
          footerNav = document.querySelector(".results-footer"),
          empty = document.querySelectorAll('#empty-state > *'),
          cont  = document.getElementById("progress-container"),
          bar   = document.getElementById("progress-bar");
    if (table.style.display !== "none") {
      table.classList.add("blur");
      footerNav?.classList.add("blur");
    }  
    wrap.classList.add('no-scroll');
    if (pag) pag.classList.add('disabled');
    empty.forEach(el => el.style.visibility = 'hidden');
    cont.style.display = "block";
    bar.style.width   = "0%";
    return startSmoothProgress();
  }
  function hideLoadingAnimation(interval) {
    const table = document.getElementById("results-table"),
          wrap  = document.querySelector('.results-table-container'),
          pag   = document.getElementById('pagination'),
          footerNav = document.querySelector(".results-footer"),
          empty = document.querySelectorAll('#empty-state > *'),
          cont  = document.getElementById("progress-container"),
          bar   = document.getElementById("progress-bar");
    clearInterval(interval);
    bar.style.width = "100%";
    setTimeout(() => {
      cont.style.display = "none";
      table.classList.remove("blur");
      footerNav?.classList.remove("blur");
      empty.forEach(el => el.style.visibility = 'visible');
      wrap.classList.remove('no-scroll');
      if (pag) pag.classList.remove('disabled');
      wrap.scrollLeft = 0;
    }, 200);
  }

  // Format numbers to 2 decimals
  function formatValue(key, value) {
    if (value === null || value === undefined) {
      return 'N/A';
    }
    if (typeof value === 'number') {
      if (key === 'Age' || key == 'Pack-Years') {
        // For Age, display as an integer.
        return Math.round(value).toString();
      } else {
        // For other numeric values, display with two decimals.
        return value.toFixed(2);
      }
    }
    return value.toString();
  }

  // Predict form AJAX
  (function () {
    const $form = $('#predictForm'),
          $btn  = $('#submitBtn'),
          $err  = $('#errorBox');
    $form.on('submit', function (e) {
      e.preventDefault();
      const fileChosen  = $('#sample_file').val();
      if (!fileChosen) return;
      $err.addClass('d-none').empty();
      $btn.prop('disabled', true);
      const prog = showLoadingAnimation();

      const fd   = new FormData(this);
      $.ajax({
        url         : $form.attr('action'),
        method      : 'POST',
        data        : fd,
        processData : false,
        contentType : false,
        success     : json => {
          clearResults();
          currentResultsSource = 'predict';
          const transformed = json.results.map(r => ({
            'Subject ID':                   r.subject_id,
            'Predicted syntax score': r.syntax_score.toFixed(2)
          }));
          fullRecords = transformed;
          displayResults(transformed);
          if (Array.isArray(json.warnings) && json.warnings.length) {
            const txt = json.warnings.map(w => {
              const pct = Math.round(w.missing_fraction * 100);
              if (w.missing_fraction > 0.50) {
                return `${w.subject_id} skipped: ${pct}% of required proteins missing.`;
              } else if (w.missing_fraction > 0.25) {
                return `${w.subject_id}: ${pct}% of required proteins missing; prediction may be unreliable.`;
              }
            }).join('<br>');
            showError('Subjects flagged for missing data:<br>' + txt);
          }
        },
        error       : xhr => {
          clearResults();
          showError(xhr.responseJSON?.error || 'Unexpected error');
        },
        complete    : () => {
          hideLoadingAnimation(prog);
          $btn.prop('disabled', false);
        }
      });
    });
  })();

  // Patient search form AJAX
  $('#patientSearchForm').on('submit', function(e) {
    e.preventDefault();
    // Clear out any "invalid" styling that might still be on the calc‐pred form
    $('#predictForm').removeClass('was-validated');
    $('#sample_file').removeClass('is-invalid');
    const $btn = $('#searchBtn');
    $('#errorBox').addClass('d-none').empty();
    $btn.prop('disabled', true);
    const prog = showLoadingAnimation();
    const formData = new FormData(this);

    // append all existing filter inputs by name
    $('#search-histology-checkboxes input:checked').each(function() {
      formData.append('histology', $(this).val());
    });
    $('#search-ultrasound-checkboxes input:checked').each(function() {
      formData.append('ultrasound', $(this).val());
    });
    $('#search-sex-checkboxes input:checked').each(function() {
      formData.append('sex', $(this).val());
    });
    $('#search-age-checkboxes input:checked').each(function() {
      formData.append('age_group', $(this).val());
    });
    $('#search-symptoms-checkboxes input:checked').each(function() {
      formData.append('symptoms', $(this).val());
    });
    $('#search-clinical-checkboxes input:checked').each(function() {
      formData.append('clinical_condition', $(this).val());
    });
    $('#search-clinical-outcomes-checkboxes input:checked').each(function() {
      formData.append('clinical_outcomes', $(this).val());
    });
    $('#search-calcification-checkboxes input:checked').each(function() {
      formData.append('calcification', $(this).val());
    });
    $('#search-medication-checkboxes input:checked').each(function() {
      formData.append('medications', $(this).val());
    });
    // lifestyle broken into three
    $('#search-lifestyle-checkboxes input[name="smoker_status"]:checked').each(function() {
      formData.append('smoker_status', $(this).val());
    });
    $('#search-lifestyle-checkboxes input[name="bmi_range"]:checked').each(function() {
      formData.append('bmi_range', $(this).val());
    });
    $('#search-lifestyle-checkboxes input[name="pack_years_range"]:checked').each(function() {
      formData.append('pack_years_range', $(this).val());
    });
    $('#search-cvbiomarkers-checkboxes input:checked').each(function() {
      formData.append('cvbiomarker', $(this).val());
    });

    $.ajax({
      url: '{% url "syntax_filter" %}',
      method: 'POST',
      data: formData,
      processData: false,
      contentType: false,
      success: json => {
        clearResults();
        currentResultsSource = 'search';
        const transformed = json.results.map(r => {
          const res = {
            'Subject ID': r.patient_id,
            'Experiment' : r.experiment,
            'Predicted syntax score': r.syntax_score.toFixed(2)
          };
          Object.keys(r).forEach(key => {
            if (!['patient_id','experiment','syntax_score','missing_fraction'].includes(key)) {
              res[ formatColumnName(key) ] = r[key];
            }
          });
          return res;
        });
        fullRecords = transformed;
        displayResults(transformed);
        if (Array.isArray(json.warnings) && json.warnings.length) {
          // If missing_frac > 50%, show “skipped” message
          const txt = json.warnings
            .filter(w => w.missing_fraction > 0.50)
            .map(w => {
              const pct = Math.round(w.missing_fraction * 100);
              return `${w.patient_id} skipped: ${pct}% of required proteins missing.`;
            })
            .join('<br>');
          showError('Subjects flagged for missing data:<br>' + txt);
        }
      },
      error: xhr => {
        clearResults();
        showError(xhr.responseJSON?.error || 'Unexpected error');
      },
      complete: () => {
        hideLoadingAnimation(prog);
        $btn.prop('disabled', false);
      }
    });
  });

  function displayResults(records) {
    allRecords = records;
    const table      = document.getElementById('results-table'),
          thead      = table.querySelector('thead'),
          emptyState = document.getElementById('empty-state'),
          footerNav  = document.querySelector('.results-footer');
          pagination  = document.getElementById('pagination');

    // Clear out old header
    thead.innerHTML = '';

    if (!records.length) {
      table.style.display = 'none';
      thead.style.display = 'none';
      emptyState.innerHTML = `
        <i class="fas fa-search-minus fa-4x"></i>
        <p>No results for the current search / filter combination.</p>
      `;
      emptyState.style.display = 'flex';
      if (footerNav) {
        footerNav.style.display = '';
      }
      if (pagination) {
        pagination.innerHTML = '';
      }
      return;
    }

    // build header
    const headerRow  = document.createElement('tr'),
          allCols    = Object.keys(records[0]);
    
    const coreCols = ['Subject ID'];
    if (allCols.includes('Experiment')) { 
      coreCols.push('Experiment');
    }
    coreCols.push('Predicted syntax score');
      
    const extraCols  = allCols.filter(c=>!coreCols.includes(c));

    coreCols.forEach(c => {
      if (allCols.includes(c)) {
        const th = document.createElement('th');
        th.textContent = c;
        headerRow.appendChild(th);
      }
    });
    extraCols.forEach(c => {
      const th = document.createElement('th');
      th.textContent = c;
      if (c === 'Calcification (clinical)') {
        th.setAttribute('data-bs-toggle','tooltip');
        th.setAttribute('title','Calcification status was determined through duplex ultrasound and CT angiography imaging, verified histologically by an experienced surgeon and pathologist. Validation included quantitative CT-based scoring (modified Agatston score), achieving high correlation (p<0.001).');
        th.setAttribute('data-bs-custom-class', 'calc-tooltip calc-hyphen');
      }
      if (c === 'COPD') {
        th.setAttribute('data-bs-toggle','tooltip');
        th.setAttribute('title','Chronic Obstructive Pulmonary Disease');
        th.setAttribute('data-bs-custom-class', 'calc-tooltip');
      }
      if (c === 'ARB therapy') {
        th.setAttribute('data-bs-toggle','tooltip');
        th.setAttribute('title','Angiotensin Receptor Blockers');
        th.setAttribute('data-bs-custom-class', 'calc-tooltip');
      }
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);

    table.style.display = 'table';
    thead.style.display = '';
    emptyState.style.display = 'none';
    if (footerNav) footerNav.style.display = 'block';

    displayResultsPage(1);
    generatePagination(records.length, 1, 10);
  }

  function displayResultsPage(page) {
    const tbody = document.getElementById('results-body');
    tbody.innerHTML = '';
    const perPage = 10,
          start   = (page-1)*perPage,
          end     = start+perPage,
          slice   = allRecords.slice(start,end),
          cols    = Array.from(
                      document.querySelectorAll('#results-table thead th')
                    ).map(th=>th.textContent);

    slice.forEach(rec => {
      const tr = document.createElement('tr');
      cols.forEach(col => {
        const td = document.createElement('td');
        td.textContent = rec[col] != null
          ? formatValue(col, rec[col])
          : 'N/A';
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }

  function searchTable() {
    const query = document.getElementById('table-search').value.trim().toLowerCase();
    if (!fullRecords.length) return;
    if (!query) {
      displayResults(fullRecords);
      return;
    }
    const filtered = fullRecords.filter(rec =>
      Object.values(rec).some(v =>
        v != null && v.toString().toLowerCase().includes(query)
      )
    );
    displayResults(filtered);
  }

  function formatColumnName(key) {
    if (
      key === 'High stenosis(≥90%)' ||
      key === 'High_Stenosis(≥90%)'
    ) {
      return 'High stenosis(≥90%)';
    }
    if (key === 'Cholesterol(total)') {
      return 'Total cholesterol(mg/dL)';
    }
    if (key === 'HDL') {
      return 'HDL(mg/dL)';
    }
    if (key === 'LDL') {
      return 'LDL(mg/dL)';
    }
    if (key === 'Triglycerides') {
      return 'Triglycerides(mg/dL)';
    }
    if (key === 'High-sensitivity CRP') {
      return 'High-sensitivity CRP(mg/dL)';
    }
    if (key === 'Ultrasensitive CRP') {
      return 'Ultrasensitive CRP(mg/dL)';
    }
    return key.replace(/_/g,' ');
  }

  function generatePagination(total, current, perPage) {
    const pagination = document.getElementById('pagination'),
          footerNav  = document.querySelector('.results-footer');
    pagination.innerHTML = '';
    const totalPages = Math.ceil(total/perPage);
    if (totalPages <= 1) {
      pagination.style.display='none';
      footerNav && footerNav.classList.add('no-pagination');
      return;
    }
    footerNav && footerNav.classList.remove('no-pagination');
    pagination.style.display='inline-flex';
    // prev
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${current===1?'disabled':''}`;
    const prevLink = document.createElement('a');
    prevLink.className = 'page-link';
    prevLink.href = '#';
    prevLink.innerHTML = '&laquo;';
    prevLink.onclick = e => { e.preventDefault(); if (current>1) goToPage(current-1); };
    prevLi.appendChild(prevLink);
    pagination.appendChild(prevLi);
    // pages
    const maxVis = 5;
    let start = Math.max(1, current-Math.floor(maxVis/2)),
        end   = Math.min(totalPages, start+maxVis-1);
    if (end-start+1 < maxVis) start = Math.max(1, end-maxVis+1);
    for (let i=start; i<=end; i++){
      const li = document.createElement('li');
      li.className = `page-item ${i===current?'active':''}`;
      const a = document.createElement('a');
      a.className = 'page-link';
      a.href = '#';
      a.textContent = i;
      a.onclick = e=>{ e.preventDefault(); goToPage(i); };
      li.appendChild(a);
      pagination.appendChild(li);
    }
    // next
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${current===totalPages?'disabled':''}`;
    const nextLink = document.createElement('a');
    nextLink.className = 'page-link';
    nextLink.href = '#';
    nextLink.innerHTML = '&raquo;';
    nextLink.onclick = e=>{ e.preventDefault(); if (current<totalPages) goToPage(current+1); };
    nextLi.appendChild(nextLink);
    pagination.appendChild(nextLi);
  }

  function goToPage(p) {
    displayResultsPage(p);
    generatePagination(allRecords.length, p, 10);
  }

  function clearResults() {
    allRecords = [];
    document.getElementById('results-body').innerHTML = '';
    document.getElementById('results-table').style.display = 'none';
    document.querySelector('#results-table thead').style.display = 'none';
    const empty = document.getElementById('empty-state');
    empty.innerHTML = `
      <i class="fas fa-search fa-4x"></i>
      <p>Use the forms above to see prediction results</p>
    `;
    empty.style.display = 'flex';
    const footerNav = document.querySelector('.results-footer');
    const pagination = document.getElementById('pagination');
    if (pagination)      pagination.style.display = 'none';
    if (footerNav) {
      footerNav.style.display = 'block';         // keep it visible
      footerNav.classList.add('no-pagination');   // add our “thick” style
    }
  }

  function showError(msg) {
    $('#errorBox').html(msg).removeClass('d-none');
  }

  function copyResults() {
    if (!allRecords.length) { alert('⚠️ No results to copy'); return; }
    const cols = Object.keys(allRecords[0]);
    let text = cols.join('\t') + '\n';
    allRecords.forEach(rec => {
      text += cols.map(c => rec[c]||'N/A').join('\t') + '\n';
    });
    navigator.clipboard.writeText(text)
      .then(() => alert('✅ Results copied to clipboard'))
      .catch(() => alert('❌ Unable to copy results.'));
  }

  function exportToExcel() {
    if (!allRecords.length) { alert('❌ No data to export'); return; }
    const ws = XLSX.utils.json_to_sheet(allRecords),
          wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Results');
    XLSX.writeFile(wb, 'predicted_syntax_scores.xlsx');
  }

  function exportToCSV() {
    if (!allRecords.length) { alert('❌ No data to export'); return; }
    const cols = Object.keys(allRecords[0]),
          header = cols.map(h=>`"${h.replace(/"/g,'""')}"`).join(','),
          lines = allRecords.map(rec =>
            cols.map(c=>`"${(rec[c]||'').toString().replace(/"/g,'""')}"`).join(',')
          );
    const blob = new Blob([ [header].concat(lines).join('\r\n') ], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob),
          a   = document.createElement('a');
    a.href = url; a.download='predicted_syntax_scores.csv';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  function exportToTSV() {
    if (!allRecords.length) { alert('❌ No data to export'); return; }
    const cols = Object.keys(allRecords[0]),
          header = cols.join('\t'),
          lines = allRecords.map(rec =>
            cols.map(c=>(rec[c]||'').toString().replace(/\t/g,' ')).join('\t')
          );
    const blob = new Blob([ [header].concat(lines).join('\r\n') ], { type: 'text/tab-separated-values;charset=utf-8;' });
    const url = URL.createObjectURL(blob),
          a   = document.createElement('a');
    a.href = url; a.download='predicted_syntax_scores.tsv';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  // initialize
  document.addEventListener('DOMContentLoaded', clearResults);
</script>
</body>
</html>