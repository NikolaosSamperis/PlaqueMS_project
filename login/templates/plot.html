{% load static %}
{% load navigation %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- jQuery and Bootstrap CSS/JS (Bootstrap 3 only) -->
    <script src="http://cdn.bootcss.com/jquery/3.1.0/jquery.min.js"></script>
    <script src="http://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdn.staticfile.org/popper.js/1.12.5/umd/popper.min.js"></script>
    <script src="http://cdn.bootcss.com/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.min.js"></script>
    <script src="http://cdn.bootcss.com/typeahead.js/0.11.1/typeahead.bundle.js"></script>
    <link href="http://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.css" rel="stylesheet">
    <link href="http://cdn.bootcss.com/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-treeview@1.2.0/dist/bootstrap-treeview.min.js"></script>
    <!-- Google Fonts for Montserrat -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <title>Plot Visualization</title>
    
    <style>
        /* PlaQuery Toolbar Styles - Start */
        .main-toolbar {
          background-color: #fff;
          color: #333;
          flex-wrap: wrap;
          padding: 0 20px;
          height: auto;
          min-height: 60px;
          display: flex;
          align-items: center;
          justify-content: flex-start;
          border-bottom: 1px solid #ccc;
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          z-index: 10;
        }
        .app-logo {
          display: flex;
          align-items: center;
          text-decoration: none;
          color: #377ba8;
          font-size: 27px;
          font-weight: bold;
          margin-right: 40px;
          transform: translateY(3px) !important;
        }
        .app-logo:hover {
          text-decoration: none;
          border-color: transparent;
        }
        .app-logo:hover .app-title {
          color: #4a90d9 !important;
          text-decoration: none;
        }
        .app-title {
          font-size: 27px;
          font-weight: bold;
          font-family: 'Montserrat', sans-serif;
          color: #377ba8 !important;
          padding-bottom: 8px;
        }
        .main-toolbar .nav-tabs {
          margin-bottom: 0;
          border-bottom: none !important;
        }
        .main-toolbar .nav-tabs > li > a {
          font-family: 'Montserrat', sans-serif !important;
          font-size: 16px !important;
          padding: 10px 15px;
          line-height: 1.42857143;
          border: 1px solid transparent;
          border-radius: 4px 4px 0 0;
          margin-right: 2px;
          color: #0d6efd;
          text-decoration: none;
          transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out;
        }

        .main-toolbar .nav-tabs > li > a:hover,
        .main-toolbar .nav-tabs > li > a:focus {
          border-color: #e9ecef #e9ecef #dee2e6; /* Bootstrap 5.1.3 hover border colors */
          background-color: #f8f9fa; /* Bootstrap 5.1.3 hover background */
          color: #0a58ca; /* Bootstrap 5.1.3 darker primary color for hover */
        }

        .main-toolbar .nav-tabs > li.active > a,
        .main-toolbar .nav-tabs > li.active > a:hover,
        .main-toolbar .nav-tabs > li.active > a:focus {
          color: #0a58ca !important;
          background-color: #f8f9fa !important;
          border-color: #e9ecef #e9ecef #dee2e6 !important;
          cursor: pointer;
        }
        
        /* Adjust content to account for fixed toolbar */
        body {
          padding-top: 60px;
          overflow-x: hidden;
        }
        #imageModal .modal-dialog {
            margin-top: 10px;
            z-index: 11;
        }

        /* Original plot.html styles */
        .treeview .list-group-item.node-checked {
            color: #0a58ca;
        }
        .treeview .list-group-item.node-selected {
            background-color: #0a58ca;
            color: #fff;
        }
        .row {
            padding-right: 80px;
            padding-left: 50px;
        }

        .table th:first-child,
        .table td:first-child {
            padding-left: 50px; 
        }

        #results-container {
            font-family: 'Montserrat', sans-serif;
        }

        #results-container .panel-heading {
            font-size: 16px;
            font-weight: bold;
            height: 60px;
            line-height: 60px;
            padding: 0 15px;
            border-bottom: 1px solid #c1bdbd;
        }

        table {
        border-collapse: separate;
        border-spacing: 0; 
        }
        
        table thead th {
            border-top: 1px solid #c1bdbdc6 !important;
        }

        .col-sm-4 {
            font-family: 'Montserrat', sans-serif;
        }
        
        .enlargeable {
          cursor: pointer;
        }

    </style>
</head>
<body>
    <!-- Toolbar copied from Home.html -->
    <div class="main-toolbar">
        <a class="app-logo">
          <span class="app-title">PlaqueMS</span>
        </a>
        <ul class="nav nav-tabs">
          <li class="nav-item">
            <a class="nav-link" href="{% url 'home' %}">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'proteins' %}">Proteins</a>
          </li>
          <li class="nav-item {% active 'plot' %}">
            <a class="nav-link" href="{% url 'plot' %}">Differential Expression Analysis</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'cy' %}">Protein Networks</a>
          </li>
          {% if user.is_authenticated %}
            <li class="nav-item">
              <a class="nav-link" href="{% url 'protein-abundance' %}">PlaQuery</a>
            </li>
          {% endif %}
          {% if user.is_authenticated and user.is_staff %}
            <li class="nav-item">
              <a class="nav-link" href="{% url 'admin_dashboard' %}">Admin Dashboard</a>
            </li>
          {% endif %}
        </ul>
        <!--Right side of the toolbar-->
        <ul class="nav nav-tabs navbar-right" style="margin-left: auto;">
          {% if user.is_authenticated %}
            <li class="nav-item">
              <a class="nav-link" href="{% url 'logout' %}">Log Out</a>
            </li>
          {% else %}
            <li class="nav-item">
              <a class="nav-link" href="{% url 'login' %}">Log In</a>
            </li>
          {% endif %}
        </ul>
    </div>

    <section id="container" class="">
        <div class="row">
            <div class="col-sm-4">
                <section class="panel">
                    <div class="panel-heading">
                        Image type:
                    </div>
                    <select id="pic_type" class="selectpicker" type="text">
                        <option value="00">boxplot</option>
                        <option value="01">volcano plot</option>
                        <option value="02">heatmap</option>
                    </select>
                    <br><br>
                    <div class="panel-heading">
                        Dataset:
                    </div>
                    <div id="tree"></div>
                </section>
            </div>
            <div class="col-sm-8">
                <section class="panel">
                    <!-- Results container that will be updated via AJAX -->
                    <div id="results-container">
                        {% include "plot_result_list.html" %}
                    </div>
                </section>
            </div>
        </div>
    </section>

    <!-- Modal for Enlarged Image -->
    <div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-labelledby="imageModalLabel">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-body">
            <img id="modalImage" alt="" class="img-responsive" style="max-width: 80%; height: auto; margin: 0 auto; display: block;">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- JavaScript at the end of body to ensure all elements are loaded -->
    <script type="text/javascript">
        var experiment_id = '{{ experiment_id }}';
        var tree = [];
        var pic_type = '{{ doc_type }}';

        window.onload = function init() {
            var doc = getQueryString("doc_type");
            console.log(doc);
            $('.selectpicker').selectpicker('val', doc);

            $.ajax({
                type: "GET",
                url: "/get_json",
                success: function (res) {
                    function pruneEmpty(nodes) {
                        nodes.forEach(function(n){
                            if (Array.isArray(n.nodes)) {
                                if (n.nodes.length === 0) {
                                    delete n.nodes;
                                } else {
                                    pruneEmpty(n.nodes);
                                }
                            }
                        });
                    }
                    pruneEmpty(res.data.nodes);

                    $('#tree').treeview({
                        data: res.data.nodes,
                        levels: 1,
                        highlightSelected: true,
                        multiSelect: false,
                        expandIcon: 'glyphicon glyphicon-plus',
                        collapseIcon: 'glyphicon glyphicon-minus',
                        emptyIcon: 'glyphicon glyphicon-minus',
                        onNodeSelected: function (event, data) {
                            experiment_id = data.id;
                            pic_type = $('#pic_type').val();
                            if (pic_type == null)
                                pic_type = '';
                            // Use AJAX to update results instead of page reload
                            loadResults(pic_type, experiment_id);
                        }
                    });
                    var selectedId = getQueryString("experiment_id");
                    if (selectedId) {
                        var allNodes = $('#tree').treeview('getNodes');
                        $.each(allNodes, function(index, node) {
                            if (node.id == selectedId) {
                                $('#tree').treeview('selectNode', [ node.nodeId, { silent: true } ]);
                                return false;
                            }
                        });
                    }
                }
            });
        };

        $('#pic_type').change(function () {
            pic_type = $('#pic_type').val();
            // Use AJAX to update results instead of page reload
            loadResults(pic_type, experiment_id);
        });

        // Function to load results via AJAX
        function loadResults(docType, experimentId, pageNumber) {
            if (pageNumber === undefined) {
                pageNumber = 1;
            }
            
            // Update URL parameters for bookmarking/sharing without reload
            var newUrl = window.location.pathname + '?doc_type=' + docType + '&experiment_id=' + experimentId;
            if (pageNumber > 1) {
                newUrl += '&page_number=' + pageNumber;
            }
            window.history.pushState({}, '', newUrl);
            
            // Fetch results via AJAX
            $.ajax({
                type: "GET",
                url: newUrl,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                success: function(response) {
                    $('#results-container').html(response);
                    // Reattach click handlers for enlargeable images
                    $('.enlargeable').on('click', function(){
                        var src = $(this).attr('src');
                        $('#modalImage').attr('src', src);
                        $('#imageModal').modal('show');
                    });
                },
                error: function() {
                    $('#results-container').html('<div class="alert alert-danger">Error loading results. Please try again.</div>');
                }
            });
        }

        function getQueryString(name) {
            let reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
            let r = window.location.search.substr(1).match(reg);
            if (r != null) {
                return unescape(r[2]);
            }
            return null;
        }

        // When an image with the class 'enlargeable' is clicked, display it in the modal
        $(document).ready(function(){
            // Initial binding for enlargeable images
            $('.enlargeable').on('click', function(){
                var src = $(this).attr('src');
                $('#modalImage').attr('src', src);
                $('#imageModal').modal('show');
            });
            
            // Initialize Bootstrap tooltips
            $('[data-toggle="tooltip"]').tooltip({
                container: 'body',
                placement: 'auto',
                trigger: 'hover'
            });
        });
        
        // Move .active to the tab just clicked; skip tabs with .keep-active (PlaQuery)
        $(function () {
          $('.main-toolbar .nav-tabs').on('pointerdown', '.nav-link', function (e) {
            const $li = $(this).parent('.nav-item'),
                  $nav = $li.closest('.nav-tabs'),
                  href = this.getAttribute('href');

            if (href === '#') {
              e.preventDefault();
            } else {
              e.preventDefault();
              setTimeout(() => { window.location.href = href; }, 150);
            }

            $nav.find('.nav-item.active').not('.keep-active').removeClass('active');
            $li.addClass('active');
          });
        });
    </script>
</body>
</html>